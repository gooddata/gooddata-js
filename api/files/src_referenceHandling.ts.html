---
layout: api
title: foobar
---
<div id="doc">
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <div id="api-tabview" class="tabview">
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul class="tabs">
                                <li><a href="#api-modules" class="category">Modules</a>
                                    <ul id="api-modules" class="apis modules">
                                        <li><a href="../modules/config.html">config</a></li>
                                        <li><a href="../modules/DataLayer.html">DataLayer</a></li>
                                        <li><a href="../modules/execution.html">execution</a></li>
                                        <li><a href="../modules/metadata.html">metadata</a></li>
                                        <li><a href="../modules/project.html">project</a></li>
                                        <li><a href="../modules/report.html">report</a></li>
                                        <li><a href="../modules/sdk.html">sdk</a></li>
                                        <li><a href="../modules/util.html">util</a></li>
                                        <li><a href="../modules/xhr.html">xhr</a></li>
                                    </ul>
                                </li>
                                <li><a href="#api-classes" class="category">Classes</a>
                                    <ul id="api-classes" class="apis classes">
                                        <li><a href="../classes/config.html">config</a></li>
                                        <li><a href="../classes/DataLayer.html">DataLayer</a></li>
                                        <li><a href="../classes/execution.html">execution</a></li>
                                        <li><a href="../classes/metadata.html">metadata</a></li>
                                        <li><a href="../classes/project.html">project</a></li>
                                        <li><a href="../classes/report.html">report</a></li>
                                        <li><a href="../classes/sdk.html">sdk</a></li>
                                        <li><a href="../classes/util.html">util</a></li>
                                        <li><a href="../classes/xhr.html">xhr</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <strong>gooddata-js</strong> <span class="version">v13.5.0</span>
                        <h1 class="file-heading">File: src/referenceHandling.ts</h1>
                        
                        <div class="file">
                            <pre class="code prettyprint linenums">
                        // (C) 2007-2020 GoodData Corporation
                        import { VisualizationObject, IVisualizationWidget } from &quot;@gooddata/typings&quot;;
                        import isEmpty from &quot;lodash/isEmpty&quot;;
                        import omit from &quot;lodash/omit&quot;;
                        import isArray from &quot;lodash/isArray&quot;;
                        import isObject from &quot;lodash/isObject&quot;;
                        import isString from &quot;lodash/isString&quot;;
                        import stringify from &quot;json-stable-stringify&quot;;
                        import { v4 as uuid } from &quot;uuid&quot;;
                        
                        import { IProperties } from &quot;./interfaces&quot;;
                        import { isUri } from &quot;./DataLayer/helpers/uri&quot;;
                        /*
                         * Helpers
                         */
                        const getReferenceValue = (id: string, references: VisualizationObject.IReferenceItems) =&gt; references[id];
                        const getReferenceId = (value: string, references: VisualizationObject.IReferenceItems) =&gt;
                            Object.keys(references).find(id =&gt; references[id] === value);
                        
                        type IdGenerator = () =&gt; string;
                        
                        const defaultIdGenerator: IdGenerator = () =&gt; uuid().replace(/-/g, &quot;&quot;);
                        
                        type StringTransformation = (value: string) =&gt; string;
                        
                        /**
                         * Recursively traverses the object and tries to apply a conversion to every string value
                         */
                        const traverse = (obj: any, convert: StringTransformation): any =&gt; {
                            if (isArray(obj)) {
                                return obj.map(a =&gt; traverse(a, convert));
                            } else if (isObject(obj)) {
                                const object = obj as Record&lt;string, any&gt;;
                                return Object.keys(object).reduce((result: any, key: string) =&gt; {
                                    result[key] = traverse(object[key], convert);
                                    return result;
                                }, {} as any);
                            } else if (isString(obj)) {
                                return convert(obj);
                            } else {
                                return obj;
                            }
                        };
                        
                        interface IConversionResult {
                            convertedProperties: IProperties;
                            convertedReferences: VisualizationObject.IReferenceItems;
                        }
                        
                        type ConversionFunction = (
                            originalProperties: IProperties,
                            originalReferences: VisualizationObject.IReferenceItems,
                            idGenerator: IdGenerator,
                        ) =&gt; IConversionResult;
                        
                        export type IObjectWithProperties = VisualizationObject.IVisualizationObject | IVisualizationWidget;
                        
                        export type ReferenceConverter = (
                            mdObject: IObjectWithProperties,
                            idGenerator?: IdGenerator,
                        ) =&gt; IObjectWithProperties;
                        
                        const createConverter = (conversionFunction: ConversionFunction): ReferenceConverter =&gt; &lt;
                            T extends IObjectWithProperties
                        &gt;(
                            mdObject: T,
                            idGenerator: IdGenerator = defaultIdGenerator,
                        ): T =&gt; {
                            const { content } = mdObject;
                            if (!content) {
                                return mdObject;
                            }
                        
                            const { properties } = content;
                            if (!properties) {
                                return mdObject;
                            }
                        
                            // prepare result objects
                            const originalProperties: IProperties = JSON.parse(properties);
                            const originalReferences = content.references || {};
                        
                            const { convertedProperties, convertedReferences } = conversionFunction(
                                originalProperties,
                                originalReferences,
                                idGenerator,
                            );
                        
                            // set the new properties and references
                            const referencesProp = isEmpty(convertedReferences) ? undefined : { references: convertedReferences };
                            const result: T = {
                                ...mdObject,
                                content: {
                                    ...omit(mdObject.content, &quot;references&quot;),
                                    properties: stringify(convertedProperties),
                                    ...referencesProp,
                                },
                            };
                        
                            return result;
                        };
                        
                        /*
                         * Conversion from References to URIs
                         */
                        const convertReferenceToUri = (
                            references: VisualizationObject.IReferenceItems,
                        ): StringTransformation =&gt; value =&gt; getReferenceValue(value, references) || value;
                        
                        /**
                         * Converts reference based values to actual URIs
                         *
                         * @param mdObject The object to convert properties of
                         * @param [idGenerator=uuid] Function that returns unique ids
                         */
                        export const convertReferencesToUris = createConverter((originalProperties, originalReferences) =&gt; {
                            const convertedProperties = traverse(originalProperties, convertReferenceToUri(originalReferences));
                        
                            return {
                                convertedProperties,
                                convertedReferences: originalReferences,
                            };
                        });
                        
                        /*
                         * Conversion from URIs to References
                         */
                        const createUriToReferenceConverter = (
                            originalReferences: VisualizationObject.IReferenceItems,
                            idGenerator: IdGenerator,
                        ) =&gt; {
                            const convertedReferences: VisualizationObject.IReferenceItems = {};
                        
                            return {
                                convertedReferences,
                                conversion: (value: string) =&gt; {
                                    if (!isUri(value)) {
                                        return value;
                                    }
                        
                                    const id =
                                        getReferenceId(value, originalReferences) || // try to reuse original references
                                        getReferenceId(value, convertedReferences) || // or use already converted new references
                                        idGenerator(); // or get a completely new id
                        
                                    convertedReferences[id] = value;
                                    return id;
                                },
                            };
                        };
                        
                        /**
                         * Converts URIs to reference based values
                         *
                         * @param mdObject The object to convert properties of
                         * @param [idGenerator=uuid] Function that returns unique ids
                         */
                        export const convertUrisToReferences = createConverter(
                            (originalProperties, originalReferences, idGenerator) =&gt; {
                                const converter = createUriToReferenceConverter(originalReferences, idGenerator);
                                const convertedProperties = traverse(originalProperties, converter.conversion);
                        
                                return {
                                    convertedProperties,
                                    convertedReferences: converter.convertedReferences,
                                };
                            },
                        );
                        
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

